## Introduction

This repository contains a [CQL](https://cql.hl7.org/) engine that is based on the [CQL reference implementation](https://github.com/cqframework/clinical_quality_language) and adapted to work with clinical data in databases which conform to the [OMOP Common Data Model](https://www.ohdsi.org/data-standardization/).
Some of the code in this repository has been generated by the [cql-on-omop code generator](https://github.com/umg-minai/cql-on-omop-code-generator).
The contents of the repository is provided under the Apache 2.0 license (see `COPYING` file).

The code in this repository can be compiled into a standalone Java application which connects to an OMOP database supports two interfaces for controlling the CQL evaluation:

* An interactive Read Eval Print Loop (REPL) which reads CQL definitions and expressions from an interactive prompt, evaluates the CQL expressions and displays the results

* Non-interactive batch processing of CQL libraries with evaluation results printed to the standard output stream

## Usage

Compile the project with

```bash
mvn package
```

Successful compilation produces a standalone application in a file like `target/cql-on-omop-1.0-SNAPSHOT.jar`.

### Interactive REPL

To start the REPL and connect to a database

```bash
CQL_ON_OMOP_DATABASE_PASSWORD=$(GET-PASSWORD) java -jar REPOSITORY-DIRECTORY/target/cql-on-omop-1.0-SNAPSHOT.jar \
  repl -p DATABASE_SERVER_PORT -u DATABASE_USERNAME -d DATABASE-NAME
```

Within the REPL, evaluate CQL expressions:

```
[0] [VisitOccurrence]
E1 => List<VisitOccurrence>
  VisitOccurrence{id=30518, concept='Inpatient Visit'}
  VisitOccurrence{id=30519, concept='Inpatient Visit'}
  VisitOccurrence{id=30520, concept='Intensive Care'}
  ...
```

#### Non-CQL Commands

The REPL supports several commands that provide functionality outside the scope of CQL.
Syntactically, these commands start with a `,` to distinguish them from valid CQL expressions.
The most important Non-CQL Commands are

* `,focus CQL-EXPRESSION`

  This command causes `CQL-EXPRESSION` to be evaluated and the resulting value, typically a list of `Person` instances or a single such instance, to be installed as the current context object or as multiple context objects (see below).

* `,reload`

  This command causes all CQL libraries that have been included via `include â€¦` lines to be re-loaded from the filesystem.
  This command is useful for developing and testing CQL libraries with a long-lived REPL session.

#### Current Context and Context Objects

CQL provides the syntax `context CONTEXT-NAME` to select one of the contexts provided by the current data model as the current context.
At the moment, `cql-on-omop` supports the contexts `Unfiltered` and `Patient`.
CQL does not specify how the value (or the values) for a context is determined or installed.
To this end, `cql-on-opop` provides the `,focus` non-CQL command to establish the connection between the current context and its value or values.

For example,

```
,focus [Person]
context Patient
```

results in a state in which each `Person` instance that is produced by the `[Person]` retrieve expression is one value of the `Patient` context.
**Any CQL expression evaluated after the above snippets will be evaluated for each context value, that is each `Person` instance in this case, individually. The results of these individual evaluations will be presented as multiple sections labeled by context value (i.e. `Person` instances) which show the respective computed value**:

```
[1] ,focus [Person]
Focussing on Person{id=0}, Person{id=1}, Person{id=2}, Person{id=3}, Person{id=4}, Person{id=5}, Person{id=6}, Person{id=7}, Person{id=8}, Person{id=9},
[2] context Patient
[3] Count([ConditionOccurrence])
Person{id=5}
E1 => Integer 2
Person{id=3}
E1 => Integer 8
Person{id=6}
E1 => Integer 3
Person{id=8}
E1 => Integer 3
Person{id=9}
E1 => Integer 1
Person{id=7}
E1 => Integer 3
Person{id=1}
E1 => Integer 6
Person{id=0}
E1 => Integer 8
Person{id=2}
E1 => Integer 5
Person{id=4}
E1 => Integer 5
```

### Batch Evaluation

To non-interactively evaluate the definitions in a CQL library, information for the database connection as well as the name of the library has to be specified on the commandline:

```bash
CQL_ON_OMOP_DATABASE_PASSWORD=$(GET-PASSWORD) java -jar REPOSITORY-DIRECTORY/target/cql-on-omop-1.0-SNAPSHOT.jar \
  batch -p DATABASE_SERVER_PORT -u DATABASE_USERNAME -d DATABASE-NAME CQL-LIBRARY-NAME
```

Evaluation results will be printed to the standard output stream of the process.
