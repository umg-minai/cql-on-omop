## Introduction

This repository contains a [CQL](https://cql.hl7.org/) engine that is based on the [CQL reference implementation](https://github.com/cqframework/clinical_quality_language) and adapted to work with clinical data in databases which conform to the [OMOP Common Data Model](https://www.ohdsi.org/data-standardization/).
Some of the code in this repository has been generated by the [cql-on-omop code generator](https://github.com/umg-minai/cql-on-omop-code-generator).

At the moment, two interfaces are supported:

* An interactive Read Eval Print Loop (REPL)

* Non-interactive batch processing of CQL libraries with evaluation results printed to the standard output stream

## Usage

Compile the project with

```bash
mvn package
```

### Interactive REPL

To start the REPL and connect to a database

```bash
CQL_ON_OMOP_DATABASE_PASSWORD=$(GET-PASSWORD) java -jar REPOSITORY-DIRECTORY/target/cql-on-omop-1.0-SNAPSHOT.jar \
  repl -p DATABASE_SERVER_PORT -u DATABASE_USERNAME -d DATABASE-NAME
```

Within the REPL, evaluate CQL expressions:

```
[0] [VisitOccurrence]
E1 => List<VisitOccurrence>
  VisitOccurrence{id=30518, concept='Inpatient Visit'}
  VisitOccurrence{id=30519, concept='Inpatient Visit'}
  VisitOccurrence{id=30520, concept='Intensive Care'}
  ...
```

#### Non-CQL Commands

The REPL supports several commands that provide functionality outside the scope of CQL.
Syntactically, these commands start with a `,` to distinguish them from valid CQL expressions.
The most important Non-CQL Commands are

* `,focus CQL-EXPRESSION`

  This command cause `CQL-EXPRESSION` to be evaluated and the resulting value, typically a list or `Person` instances or a single such instance, to be installed as the current context object or as multiple context objects (see below).

#### Current Context and Context Objects

CQL provides the syntax `context CONTEXT-NAME` to select one of the contexts provided by the current data model as the current context.
At the moment, `cql-on-omop` supports the contexts `Unfiltered` and `Patient`.
CQL does not specify how the value (or the values) for a context is determined or installed.
To this end, `cql-on-opop` provides the `,focus` non-CQL command to establish the connection between the current context and its value or values.

For example,

```
,focus [Person]
context Patient
```

results in a state in which each `Person` instance that is produced by the `[Person]` retrieve expression is one context value.
**Any CQL expression following the above snippets will be evaluated for each context value, that is each `Person` instance in this case, individually. The results of these individual evaluations will be presented as a dictionary that maps context values (i.e. `Person` instances) to the respective computed value**:

```
[1] ,focus [Person]
Focussing on Person{id=0}, Person{id=1}, Person{id=2}, Person{id=3}, Person{id=4}, Person{id=5}, Person{id=6}, Person{id=7}, Person{id=8}, Person{id=9},
[2] context Patient
[3] Count([ConditionOccurrence])
E1 => Tuple Tuple {
  Person{id=1}: 2
  Person{id=0}: 4
  Person{id=7}: 3
  Person{id=6}: 3
  Person{id=9}: 1
  Person{id=8}: 3
  Person{id=3}: 4
  Person{id=2}: 1
  Person{id=5}: 2
  Person{id=4}: 1
}
```

### Batch Evaluation

To non-interactively evaluate the definitions in a CQL library, information for the database connection as well as the name of the library has to be specified on the commandline:

```bash
CQL_ON_OMOP_DATABASE_PASSWORD=$(GET-PASSWORD) java -jar REPOSITORY-DIRECTORY/target/cql-on-omop-1.0-SNAPSHOT.jar \
  batch -p DATABASE_SERVER_PORT -u DATABASE_USERNAME -d DATABASE-NAME CQL-LIBRARY-NAME
```

Evaluation results will be printed to the standard output stream of the process.
